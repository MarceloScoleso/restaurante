<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head(title='Pedido')"></head>
<body>
<div class="container">
    <h2 th:text="${pedido.id != null} ? 'Editar Pedido' : 'Novo Pedido'"></h2>

    <form th:action="@{/pedidos}" th:object="${pedido}" method="post" id="pedidoForm">
        <label>Cliente</label>
        <select th:field="*{cliente}" required>
            <option th:each="cliente : ${clientes}" th:value="${cliente}" th:text="${cliente.nome}"></option>
        </select>

        <label>Mesa</label>
        <select th:field="*{mesa}" required>
            <option th:each="mesa : ${mesas}" th:value="${mesa}" th:text="${mesa.numero}"></option>
        </select>

        <label>Status</label>
        <select th:field="*{status}">
            <option th:each="status : ${status}" th:value="${status}" th:text="${status}"></option>
        </select>

        <!-- Itens do pedido -->
        <h4>Itens do Pedido</h4>
        <div id="itensContainer">
            <div class="item" th:each="item, iterStat : *{itens}">
                <label>Produto</label>
                <select th:field="*{itens[__${iterStat.index}__].produto}">
                    <option th:each="produto : ${produtos}" th:value="${produto}" th:text="${produto.nome}"></option>
                </select>

                <label>Quantidade</label>
                <input type="number" th:field="*{itens[__${iterStat.index}__].quantidade}" min="1"/>

                <button type="button" class="btn btn-danger removeBtn">Remover</button>
                <hr/>
            </div>
        </div>

        <button type="button" class="btn btn-secondary" id="addItemBtn">Adicionar Item</button>
        <br/><br/>
        <button type="submit" class="btn btn-success">Salvar</button>
    </form>
</div>

<footer th:replace="fragments/footer :: footer"></footer>

<script>
    const produtos = /*[[${produtos}]]*/ []; // Thymeleaf vai preencher os produtos
    const itensContainer = document.getElementById('itensContainer');
    const addItemBtn = document.getElementById('addItemBtn');

    function createItem(index) {
        const div = document.createElement('div');
        div.classList.add('item');

        // Produto select
        const labelProduto = document.createElement('label');
        labelProduto.innerText = 'Produto';
        div.appendChild(labelProduto);

        const selectProduto = document.createElement('select');
        selectProduto.name = `itens[${index}].produto.id`;
        selectProduto.classList.add('form-select');
        produtos.forEach(prod => {
            const option = document.createElement('option');
            option.value = prod.id;
            option.text = prod.nome;
            selectProduto.appendChild(option);
        });
        div.appendChild(selectProduto);

        // Quantidade
        const labelQtd = document.createElement('label');
        labelQtd.innerText = 'Quantidade';
        div.appendChild(labelQtd);

        const inputQtd = document.createElement('input');
        inputQtd.type = 'number';
        inputQtd.name = `itens[${index}].quantidade`;
        inputQtd.min = 1;
        inputQtd.value = 1;
        inputQtd.classList.add('form-control');
        div.appendChild(inputQtd);

        // Remover button
        const btnRemove = document.createElement('button');
        btnRemove.type = 'button';
        btnRemove.classList.add('btn', 'btn-danger', 'removeBtn', 'mt-1');
        btnRemove.innerText = 'Remover';
        btnRemove.addEventListener('click', () => {
            div.remove();
            updateIndices();
        });
        div.appendChild(btnRemove);

        // Separator
        div.appendChild(document.createElement('hr'));

        return div;
    }

    function updateIndices() {
        const items = document.querySelectorAll('#itensContainer .item');
        items.forEach((div, index) => {
            const select = div.querySelector('select');
            const input = div.querySelector('input');
            select.name = `itens[${index}].produto.id`;
            input.name = `itens[${index}].quantidade`;
        });
    }

    addItemBtn.addEventListener('click', () => {
        const index = document.querySelectorAll('#itensContainer .item').length;
        const newItem = createItem(index);
        itensContainer.appendChild(newItem);
    });

    // Remover items existentes
    document.querySelectorAll('.removeBtn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.target.closest('.item').remove();
            updateIndices();
        });
    });
</script>
</body>
</html>
