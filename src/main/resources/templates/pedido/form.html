<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Pedido</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<!-- Header -->
<div th:replace="fragments/header :: navbar"></div>

<div class="container">
    <h2 th:text="${pedido.id != null} ? 'Editar Pedido' : 'Novo Pedido'"></h2>

    <form th:action="@{/pedidos}" method="post" id="pedidoForm">
        <!-- ID do pedido para edição -->
        <input type="hidden" name="id" th:value="${pedido.id}"/>

        <!-- Restaurante -->
        <label>Restaurante</label>
        <select id="restauranteSelect" name="restauranteId" class="form-select" required>
            <option value="" disabled>-- Selecione o restaurante --</option>
            <option th:each="rest : ${restaurantes}" 
                    th:value="${rest.id}" 
                    th:text="${rest.nome}"
                    th:selected="${pedido.mesa != null and pedido.mesa.restaurante.id == rest.id}">
            </option>
        </select>

        <!-- Mesa -->
        <label>Mesa</label>
        <select name="mesaId" class="form-select" required>
            <option value="" disabled>-- Selecione a mesa --</option>
            <option th:each="mesa : ${mesas}" 
                    th:value="${mesa.id}" 
                    th:text="${mesa.numero}" 
                    th:attr="data-restaurante-id=${mesa.restaurante.id}"
                    th:selected="${pedido.mesa != null and mesa.id == pedido.mesa.id}">
            </option>
        </select>

        <!-- Cliente -->
        <label>Cliente</label>
        <select name="clienteId" class="form-select" required>
            <option value="" disabled>-- Selecione o cliente --</option>
            <option th:each="cliente : ${clientes}" 
                    th:value="${cliente.id}" 
                    th:text="${cliente.nome}" 
                    th:selected="${pedido.cliente != null and cliente.id == pedido.cliente.id}">
            </option>
        </select>

        <!-- Status -->
        <label>Status</label>
        <select name="status" class="form-select">
            <option th:each="statusOption : ${status}" 
                    th:value="${statusOption}" 
                    th:text="${statusOption}" 
                    th:selected="${pedido.status == statusOption}">
            </option>
        </select>

        <!-- Itens do Pedido -->
        <h4>Item do Pedido</h4>
        <label>Produto</label>
        <select id="produtoSelect" name="produtoId" class="form-select" required>
            <option value="" disabled>-- Selecione o produto --</option>
            <option th:each="produto : ${produtos}" 
                    th:value="${produto.id}" 
                    th:text="${produto.nome}" 
                    th:attr="data-preco=${produto.preco}" 
                    th:selected="${not #lists.isEmpty(pedido.itens) and produto.id == pedido.itens[0].produto.id}">
            </option>
        </select>

        <label>Quantidade</label>
        <input type="number" id="quantidadeInput" name="quantidade" min="1" class="form-control" required
               th:value="${not #lists.isEmpty(pedido.itens) ? pedido.itens[0].quantidade : 1}"/>

        <label>Total</label>
        <input type="text" id="totalInput" name="total" class="form-control" readonly
               th:value="${not #lists.isEmpty(pedido.itens) ? pedido.itens[0].subtotal : 0.00}"/>

        <br/><br/>
        <button type="submit" class="btn btn-success">Salvar</button>
        <a class="btn btn-secondary" th:href="@{/pedidos}">Cancelar</a>
    </form>
</div>

<!-- Footer -->
<div th:replace="fragments/footer :: footer"></div>

<script>
const produtoSelect = document.getElementById('produtoSelect');
const quantidadeInput = document.getElementById('quantidadeInput');
const totalInput = document.getElementById('totalInput');
const restauranteSelect = document.getElementById('restauranteSelect');
const mesaSelect = document.querySelector('select[name="mesaId"]');

// Atualiza total ao mudar produto ou quantidade
function atualizarTotal() {
    const selectedOption = produtoSelect.selectedOptions[0];
    const preco = parseFloat(selectedOption?.dataset.preco || 0);
    const quantidade = parseInt(quantidadeInput.value) || 0;
    totalInput.value = (preco * quantidade).toFixed(2);
}

// Filtra mesas pelo restaurante selecionado
restauranteSelect.addEventListener('change', function() {
    const restauranteId = this.value;
    Array.from(mesaSelect.options).forEach(option => {
        option.style.display = option.dataset.restauranteId === restauranteId ? '' : 'none';
    });
    mesaSelect.value = ""; // limpa seleção ao trocar de restaurante
});

produtoSelect.addEventListener('change', atualizarTotal);
quantidadeInput.addEventListener('input', atualizarTotal);

// Calcula total ao carregar a página (no caso de edição)
window.addEventListener('load', atualizarTotal);
</script>

</body>
</html>
